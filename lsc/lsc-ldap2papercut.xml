<?xml version="1.0"?>
<lsc xmlns="http://lsc-project.org/XSD/lsc-core-2.1.xsd" xmlns:exec="http://lsc-project.org/XSD/lsc-executable-plugin-1.0.xsd">
  <connections>
    <ldapConnection>
      <name>openldap</name>
      <url>ldap://10.0.2.4:389/dc=demo,dc=fusion</url>
      <username>cn=admin,dc=demo,dc=fusion</username>
      <password>passldap</password>
      <authentication>SIMPLE</authentication>
    </ldapConnection>
    <pluginConnection>
      <name>executable</name>
      <url>fake</url>
      <username>fake</username>
      <password>fake</password>
    </pluginConnection>
  </connections>
  <tasks>
    <task>
      <name>Users</name>
      <bean>org.lsc.beans.SimpleBean</bean>
      <ldapSourceService>
        <name>openldap-source-service</name>
        <connection reference="openldap" />
        <baseDn>dc=demo,dc=fusion</baseDn>
        <pivotAttributes>
          <string>uid</string>
        </pivotAttributes>
        <fetchedAttributes>
          <string>uid</string>
          <string>supannAliasLogin</string>
          <string>description</string>
          <string>mail</string>
          <string>employeeNumber</string>
          <string>cn</string>
          <string>supannCMSAffectation</string>
<!--          <string>supannCMSAppAffectation</string> -->
          <string>ou</string>
          <string>roomNumber</string>
          <string>employeNumber</string>
          <string>displayName</string>
        </fetchedAttributes>
        <getAllFilter><![CDATA[(&(objectClass=inetOrgPerson)(uid=*)(supannListeRouge=TRUE))]]></getAllFilter>
        <getOneFilter><![CDATA[(&(objectClass=inetOrgPerson)(uid={uid})(supannListeRouge=TRUE))]]></getOneFilter>
        <cleanFilter><![CDATA[(&(objectClass=inetOrgPerson)(uid={uid})(supannListeRouge=TRUE))]]></cleanFilter>
      </ldapSourceService>
      <pluginDestinationService implementationClass="org.lsc.plugins.connectors.executable.ExecutableLdifDestinationService">
        <name>user-dst-service</name>
        <connection reference="executable"/>
        <exec:executableLdifDestinationServiceSettings>
          <name>user-dst-service-exec</name>
          <connection reference="executable"/>
          <exec:listScript>/srv/lsc-script-papercut/list.sh</exec:listScript>
          <exec:getScript>/srv/lsc-script-papercut/get.sh</exec:getScript>
          <exec:addScript>/srv/lsc-script-papercut/add.sh</exec:addScript>
          <exec:updateScript>/srv/lsc-script-papercut/update.sh</exec:updateScript>
          <exec:removeScript>/srv/lsc-script-papercut/remove.sh</exec:removeScript>
          <exec:renameScript/>
          <exec:variables>
            <entry>
              <key>LSC_PC_BIN_PATH</key>
              <value>/srv/lsc-script-papercut/</value>
            </entry>
            <entry>
              <key>LSC_PC_LOG_LEVEL</key>
              <value>/tmp/log-file-from-env.log</value>
            </entry>
            <entry>
              <key>LSC_PC_LOG_FILE</key>
              <value>/tmp/log-file-from-env.log</value>
            </entry>
            <entry>
              <key>LSC_PC_URL</key>
              <value>http://10.0.2.16:9191/</value>
            </entry>
            <entry>
              <key>LSC_PC_TOKEN</key>
              <value>TestAPIKey</value>
            </entry>
            <entry>
              <key>LSC_PC_PIVOT</key>
              <value>uid</value>
            </entry>
            <entry>
              <key>LSC_PC_ATTRIBUTS</key>
              <value>card-number,card-pin,department,email,full-name,notes,office,username-alias,primary-card-number,secondary-card-number</value>
            </entry>
          </exec:variables>
          <exec:fetchedAttributes>
            <string>username-alias</string>
            <string>notes</string>
            <string>email</string>
            <string>full-name</string>
            <string>secondary-card-number</string>
            <string>primary-card-number</string>
            <string>office</string>
            <string>department</string>
          </exec:fetchedAttributes>
        </exec:executableLdifDestinationServiceSettings>
      </pluginDestinationService>
      <propertiesBasedSyncOptions>
        <mainIdentifier>srcBean.getMainIdentifier()</mainIdentifier>
        <defaultDelimiter>;</defaultDelimiter>
        <defaultPolicy>FORCE</defaultPolicy>
        <conditions>
          <create>true</create>
          <update>true</update>
          <delete>true</delete>
          <changeId>false</changeId>
        </conditions>
        <dataset>
          <name>username-alias</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("supannAliasLogin")</string>
          </forceValues>
        </dataset>
        <dataset>
          <name>email</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("mail")</string>
          </forceValues>
        </dataset>
        <dataset>
          <name>notes</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("description")</string>
          </forceValues>
        </dataset>
        <dataset>
          <name>full-name</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("displayName")</string>
          </forceValues>
        </dataset>
<!-- This config implies that there only one value -->
        <dataset>
          <name>secondary-card-number</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>js:extractPCId(srcBean.getDatasetFirstValueById("supannCMSAffectation"))</string>
          </forceValues>
        </dataset>
<!--
        <dataset>
          <name>secondary-card-number</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>js:extractPCIdPerApp(srcBean.getDatasetValuesById("supannCMSAppAffectation"),"PAPERCUT")</string>
          </forceValues>
        </dataset> -->


        <dataset>
          <name>primary-card-number</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("employeeNumber").toLowerCase()</string>
          </forceValues>
        </dataset>
        <dataset>
          <name>office</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("roomNumber")</string>
          </forceValues>
        </dataset>
        <dataset>
          <name>department</name>
          <policy>FORCE</policy>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("ou")</string>
          </forceValues>
        </dataset>
      </propertiesBasedSyncOptions>
      <scriptInclude>
        <string>./lib/supannCMSId.js</string>
      </scriptInclude>
    </task>
  </tasks>
</lsc>
